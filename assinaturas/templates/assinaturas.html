{% extends 'base.html' %}

{% block title %}Assinaturas - Meu Bolso{% endblock %}
{% block page_title %}Gerenciar Assinaturas{% endblock %}

{% block content %}
<!-- Header com estatísticas e botão de nova assinatura -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card-custom">
            <div class="d-flex align-items-center gap-3">
                <div style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-credit-card" style="font-size: 1.5rem; color: var(--accent-blue);"></i>
                </div>
                <div>
                    <p class="text-secondary-custom mb-1" style="font-size: 0.875rem;">Total</p>
                    <h3 class="mb-0" style="font-weight: 600;">{{ total_assinaturas }}</h3>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card-custom">
            <div class="d-flex align-items-center gap-3">
                <div style="width: 48px; height: 48px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-check-circle" style="font-size: 1.5rem; color: var(--accent-green);"></i>
                </div>
                <div>
                    <p class="text-secondary-custom mb-1" style="font-size: 0.875rem;">Ativas</p>
                    <h3 class="mb-0" style="font-weight: 600;">{{ assinaturas_ativas }}</h3>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 text-end">
        <a href="{% url 'criar_assinatura' %}" class="btn-primary-custom" style="display: inline-flex;">
            <i class="bi bi-plus-lg"></i> Nova Assinatura
        </a>
    </div>
</div>

<!-- Filtros -->
<div class="card-custom mb-4">
    <form method="GET" action="{% url 'assinaturas' %}">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label" style="font-size: 0.875rem; font-weight: 500;">Buscar</label>
                <input 
                    type="text" 
                    name="search" 
                    class="form-control-custom" 
                    placeholder="Nome da assinatura..."
                    value="{{ search }}"
                >
            </div>
            
            <div class="col-md-3">
                <label class="form-label" style="font-size: 0.875rem; font-weight: 500;">Status</label>
                <select name="status" class="form-control-custom">
                    <option value="">Todos</option>
                    <option value="ATIVA" {% if status_filter == 'ATIVA' %}selected{% endif %}>Ativa</option>
                    <option value="PAUSADA" {% if status_filter == 'PAUSADA' %}selected{% endif %}>Pausada</option>
                    <option value="CANCELADA" {% if status_filter == 'CANCELADA' %}selected{% endif %}>Cancelada</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label class="form-label" style="font-size: 0.875rem; font-weight: 500;">Categoria</label>
                <select name="categoria" class="form-control-custom">
                    <option value="">Todas</option>
                    {% for categoria in categorias %}
                        <option value="{{ categoria.id }}" {% if categoria_filter == categoria.id|stringformat:"s" %}selected{% endif %}>
                            {{ categoria.nome }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn-primary-custom w-100">
                    <i class="bi bi-funnel"></i> Filtrar
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Tabela de Assinaturas -->
<div class="card-custom">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 style="font-size: 1.25rem; font-weight: 600; margin: 0;">
            Minhas Assinaturas
            {% if search or status_filter or categoria_filter %}
                <span class="badge" style="background: rgba(59, 130, 246, 0.1); color: var(--accent-blue); font-size: 0.875rem; font-weight: 500;">
                    Filtrado
                </span>
            {% endif %}
        </h3>
        
        <div class="d-flex gap-2">
            <select class="form-control-custom" style="width: auto;" onchange="window.location.href='?order_by='+this.value">
                <option value="-data_criacao" {% if order_by == '-data_criacao' %}selected{% endif %}>Mais recentes</option>
                <option value="data_criacao" {% if order_by == 'data_criacao' %}selected{% endif %}>Mais antigas</option>
                <option value="nome" {% if order_by == 'nome' %}selected{% endif %}>Nome (A-Z)</option>
                <option value="-nome" {% if order_by == '-nome' %}selected{% endif %}>Nome (Z-A)</option>
                <option value="valor" {% if order_by == 'valor' %}selected{% endif %}>Menor valor</option>
                <option value="-valor" {% if order_by == '-valor' %}selected{% endif %}>Maior valor</option>
            </select>
        </div>
    </div>

    {% if assinaturas %}
    <div class="table-responsive">
        <table class="table table-dark table-hover" style="margin: 0;">
            <thead>
                <tr style="border-color: var(--border-color);">
                    <th style="padding: 1rem; font-weight: 600; color: var(--text-secondary);">Assinatura</th>
                    <th style="padding: 1rem; font-weight: 600; color: var(--text-secondary);">Categoria</th>
                    <th style="padding: 1rem; font-weight: 600; color: var(--text-secondary);">Valor</th>
                    <th style="padding: 1rem; font-weight: 600; color: var(--text-secondary);">Ciclo</th>
                    <th style="padding: 1rem; font-weight: 600; color: var(--text-secondary);">Próxima Cobrança</th>
                    <th style="padding: 1rem; font-weight: 600; color: var(--text-secondary);">Status</th>
                    <th style="padding: 1rem; font-weight: 600; color: var(--text-secondary); text-align: center;">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for assinatura in assinaturas %}
                <tr style="border-color: var(--border-color);">
                    <td style="padding: 1rem;">
                        <div class="d-flex align-items-center gap-3">
                            <div style="width: 48px; height: 48px; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-app" style="color: var(--accent-blue); font-size: 1.25rem;"></i>
                            </div>
                            <div>
                                <div style="font-weight: 500;">{{ assinatura.nome }}</div>
                                {% if assinatura.descricao %}
                                <div class="text-secondary-custom" style="font-size: 0.875rem;">
                                    {{ assinatura.descricao|truncatewords:8 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        {% if assinatura.categoria %}
                        <span class="badge" style="background: {{ assinatura.categoria.cor }}33; color: {{ assinatura.categoria.cor }}; font-weight: 500;">
                            <i class="bi bi-tag-fill"></i> {{ assinatura.categoria.nome }}
                        </span>
                        {% else %}
                        <span class="text-secondary-custom">Sem categoria</span>
                        {% endif %}
                    </td>
                    <td style="padding: 1rem;">
                        <div style="font-weight: 600; font-size: 1.125rem;">R$ {{ assinatura.valor|floatformat:2 }}</div>
                        <div class="text-secondary-custom" style="font-size: 0.75rem;">
                            ~R$ {{ assinatura.valor_mensal|floatformat:2 }}/mês
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <span class="text-secondary-custom">{{ assinatura.get_ciclo_pagamento_display }}</span>
                    </td>
                    <td style="padding: 1rem;">
                        {% if assinatura.dias_ate_proxima_cobranca <= 7 %}
                        <span style="color: var(--accent-yellow); font-weight: 500;">
                            <i class="bi bi-clock"></i> {{ assinatura.data_proxima_cobranca|date:"d/m/Y" }}
                        </span>
                        <div class="text-secondary-custom" style="font-size: 0.75rem;">
                            {% if assinatura.dias_ate_proxima_cobranca == 0 %}
                                Hoje
                            {% elif assinatura.dias_ate_proxima_cobranca == 1 %}
                                Amanhã
                            {% else %}
                                {{ assinatura.dias_ate_proxima_cobranca }} dias
                            {% endif %}
                        </div>
                        {% else %}
                        <span class="text-secondary-custom">
                            {{ assinatura.data_proxima_cobranca|date:"d/m/Y" }}
                        </span>
                        <div class="text-secondary-custom" style="font-size: 0.75rem;">
                            {{ assinatura.dias_ate_proxima_cobranca }} dias
                        </div>
                        {% endif %}
                    </td>
                    <td style="padding: 1rem;">
                        {% if assinatura.status == 'ATIVA' %}
                        <span class="badge" style="background: rgba(16, 185, 129, 0.1); color: var(--accent-green); font-weight: 500;">
                            <i class="bi bi-check-circle"></i> Ativa
                        </span>
                        {% elif assinatura.status == 'PAUSADA' %}
                        <span class="badge" style="background: rgba(245, 158, 11, 0.1); color: var(--accent-yellow); font-weight: 500;">
                            <i class="bi bi-pause-circle"></i> Pausada
                        </span>
                        {% else %}
                        <span class="badge" style="background: rgba(239, 68, 68, 0.1); color: var(--accent-red); font-weight: 500;">
                            <i class="bi bi-x-circle"></i> Cancelada
                        </span>
                        {% endif %}
                    </td>
                    <td style="padding: 1rem; text-align: center;">
                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn btn-sm" style="background: var(--bg-tertiary); color: var(--accent-blue); border: none; padding: 0.5rem 0.75rem; border-radius: 0.375rem;">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm" style="background: var(--bg-tertiary); color: var(--accent-red); border: none; padding: 0.5rem 0.75rem; border-radius: 0.375rem;">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="bi bi-inbox" style="font-size: 4rem; color: var(--text-secondary); opacity: 0.5;"></i>
        <p class="text-secondary-custom mt-3 mb-4">
            {% if search or status_filter or categoria_filter %}
                Nenhuma assinatura encontrada com os filtros aplicados.
            {% else %}
                Você ainda não possui assinaturas cadastradas.
            {% endif %}
        </p>
        <a href="{% url 'criar_assinatura' %}" class="btn-primary-custom">
            <i class="bi bi-plus-lg"></i> Adicionar Primeira Assinatura
        </a>
    </div>
    {% endif %}
</div>

<style>
    .form-control-custom {
        width: 100%;
        padding: 0.625rem 0.875rem;
        background-color: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        color: var(--text-primary);
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }
    
    .form-control-custom:focus {
        outline: none;
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }
</style>
{% endblock %}
